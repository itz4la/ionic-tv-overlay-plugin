import{a as g}from"./chunk-YV6SONE4.js";import{b as W}from"./chunk-2BJLPANP.js";import{c as B,e as V}from"./chunk-5GVKMHBT.js";import"./chunk-S2XR63X6.js";import{d as H}from"./chunk-36TWDYNZ.js";import{Ca as O,Eb as I,G as _,Gb as N,Hb as F,Ja as T,K as P,N as d,P as S,Ra as M,Ta as L,X as k,a as f,ba as E,e as v,g as C,ga as D,l as y,r as x,u as b}from"./chunk-4YXWHVVD.js";import"./chunk-PHJ65MTQ.js";import"./chunk-NGAVIYQ2.js";import"./chunk-DFS7RQGK.js";import"./chunk-IP3IRUG3.js";import"./chunk-YUJWRDDX.js";import"./chunk-HC6MZPB3.js";import"./chunk-QOCRLRQJ.js";import"./chunk-RMJ7PCZJ.js";import"./chunk-LSZSCLUI.js";import"./chunk-T6LT6B37.js";import"./chunk-QAYK5YJO.js";import"./chunk-EZ6AITSJ.js";import"./chunk-GNOVVPTF.js";import"./chunk-5OMUW5VI.js";import"./chunk-OBXDPQ3V.js";import"./chunk-HE67GXZG.js";import"./chunk-MCRJI3T3.js";import"./chunk-BAKMWPBW.js";import"./chunk-3VVAHO66.js";import"./chunk-6MXH2XA5.js";import"./chunk-7UI5LT65.js";import"./chunk-PDVW5TD3.js";import"./chunk-WR6SSK3X.js";import"./chunk-ILEDPWO7.js";import"./chunk-JWIEPCRG.js";import"./chunk-C5RQ2IC2.js";import"./chunk-SV7S5NYR.js";import{i as u}from"./chunk-OYAVQN5W.js";var $=g("ExoPlayer"),z=$;var U=g("TVOverlay"),h=U;var A=(()=>{let r=class r{constructor(e){this.requestsService=e,this.channels=[],this.currentChannelSubject=new f(this.channels.find(t=>t.active)||this.channels[0]),this.showOverlaySubject=new f(!1)}getChannels(){return this.requestsService.get("/channels/access").pipe(C(e=>{let n=JSON.parse(this.requestsService.decrypt(e.data)).channels,i=n.find(o=>o.authorized);return i&&this.currentChannelSubject.next(i),this.channels=n,n}),y(e=>{let t=JSON.parse(this.requestsService.decrypt(e.error.data));return v(()=>new Error(t.message||"Failed to fetch channels"))}))}getWeeklyEpg(){return this.requestsService.get("/channels/epg/weekly").pipe(C(e=>JSON.parse(this.requestsService.decrypt(e.data))),y(e=>{let t=JSON.parse(this.requestsService.decrypt(e.error.data));return v(()=>new Error(t.message||"Failed to fetch weekly EPG data"))}))}getCurrentChannel(){return this.currentChannelSubject.asObservable()}getShowOverlay(){return this.showOverlaySubject.asObservable()}setCurrentChannel(e){let t=this.channels.find(n=>n.index===e);if(t&&t.authorized)this.channels.forEach(n=>n.active=!1),t.active=!0,this.currentChannelSubject.next(t);else{let n=this.channels.find(i=>i.active);n&&this.currentChannelSubject.next(n)}}nextChannel(){let t=(this.channels.findIndex(i=>i.active)+1)%this.channels.length,n=0;for(;!this.channels[t].authorized&&n<this.channels.length;)t=(t+1)%this.channels.length,n++;this.channels[t].authorized&&this.setCurrentChannel(this.channels[t].index)}previousChannel(){let t=(this.channels.findIndex(i=>i.active)-1+this.channels.length)%this.channels.length,n=0;for(;!this.channels[t].authorized&&n<this.channels.length;)t=(t-1+this.channels.length)%this.channels.length,n++;this.channels[t].authorized&&this.setCurrentChannel(this.channels[t].index)}showOverlay(e){this.showOverlaySubject.next(e)}toggleOverlay(){let e=this.showOverlaySubject.value;this.showOverlay(!e)}};r.\u0275fac=function(t){return new(t||r)(b(W))},r.\u0275prov=x({token:r,factory:r.\u0275fac,providedIn:"root"});let p=r;return p})();var Pe=(()=>{let r=class r{constructor(e,t,n,i,o,a,s){this.channelService=e,this.navController=t,this.cdr=n,this.ngZone=i,this.route=o,this.router=a,this.platform=s,this.isListening=!1,this.playerLoaded=!1,this.channels=[],this.currentChannel=null,this.isVideoLoading=!0,this.showLogo=!1,this.cachedProgress=0,this.lastProgressUpdate=0,this.PROGRESS_UPDATE_INTERVAL=1e3,this.selectedChannelId="",this.selectedQuality="auto",this.isOverlayShowed=!1,this.showEpg=!1,this.isLoadingEpg=!1,this.weeklyEpgData=null,this.epgRequested=!1,this.backButtonPressed=!1;let l=this.router.getCurrentNavigation(),c=l==null?void 0:l.extras.state;c!=null&&c.selectedChannel?this.selectedChannelId=c.selectedChannel:console.error("No channel ID provided in navigation state")}ngOnInit(){this.setupBackButtonHandler()}ngOnDestroy(){this.player&&this.player.dismiss(),this.selectedChannelId="",this.backButtonTimeout&&clearTimeout(this.backButtonTimeout)}setupBackButtonHandler(){window.handleBackButton=()=>{if(console.log("Back button pressed from Android - live-tv page"),this.backButtonPressed){console.log("Back button already pressed, ignoring duplicate");return}this.backButtonPressed=!0,this.ngZone.run(()=>{console.log("Back button pressed from Android - live-tv page"),this.handleKeyboardEvent(new KeyboardEvent("keydown",{key:"Backspace"}))}),this.backButtonTimeout=setTimeout(()=>{this.backButtonPressed=!1},300)}}onBack(){this.navController.back()}ionViewDidEnter(){this.isListening=!0,this.backButtonSub=this.platform.backButton.subscribeWithPriority(10,()=>{this.onReturn()}),this.isVideoLoading=!0,this.loadChannels(),this.channelService.getCurrentChannel().subscribe(e=>{this.currentChannel=e,this.player&&e&&this.loadChannel(e)}),this.startProgressUpdates(),this.initializePlayer()}ionViewDidLeave(){console.log("LiveTvPage: ionViewDidLeave"),this.destroyTVOverlay(),this.disableNativeOverlay(),typeof window<"u"&&(delete window.onNativeChannelSelected,delete window.onNativeProgramSelected,delete window.onNativeQualitySelected,delete window.onNativeOverlayVisibilityChanged,delete window.onNativeInfoButtonClicked,delete window.onNativeEpgButtonClicked,delete window.onNativeSettingsButtonClicked)}resetVar(){this.isListening=!1,this.backButtonSub&&this.backButtonSub.unsubscribe(),this.player&&(this.player.dismiss(),this.player=null),this.stopProgressUpdates(),this.playerLoaded=!1,this.currentChannel=null,this.isVideoLoading=!0,this.showLogo=!1,this.isOverlayShowed=!1,this.selectedChannelId="";let e=document;(e.fullscreenElement||e.mozFullScreenElement||e.webkitFullscreenElement||e.msFullscreenElement)&&(e.exitFullscreen?e.exitFullscreen():e.mozCancelFullScreen?e.mozCancelFullScreen():e.webkitExitFullscreen?e.webkitExitFullscreen():e.msExitFullscreen&&e.msExitFullscreen()),this.destroyTVOverlay()}startProgressUpdates(){this.progressUpdateInterval=setInterval(()=>{this.lastProgressUpdate=0,this.getProgramProgress(),this.updateNativeProgramProgress(),this.cdr.detectChanges()},3e4)}stopProgressUpdates(){this.progressUpdateInterval&&(clearInterval(this.progressUpdateInterval),this.progressUpdateInterval=null)}loadChannels(){this.channelService.getChannels().subscribe({next:e=>{for(let t=0;t<e.length;t++){let n=e[t];n.index=t+1}if(this.channels=e,this.selectedChannelId){let t=this.channels.find(n=>n._id===this.selectedChannelId);t&&(t.active=!0,this.channelService.setCurrentChannel(t.index))}else if(this.currentChannel){let t=this.channels.find(n=>n.index===this.currentChannel.index);t&&(t.active=!0)}this.updateNativeChannelList(),this.updateNativeProgramList(),this.initializePlayer()},error:e=>{console.error("Error loading channels:",e)}})}loadWeeklyEpgData(){this.isLoadingEpg=!0,this.channelService.getWeeklyEpg().subscribe({next:e=>{this.weeklyEpgData=e,this.isLoadingEpg=!1,this.epgRequested&&!this.showEpg&&(this.showEpg=!0,setTimeout(()=>{this.focusEpgComponent()},100))},error:e=>{console.error("Error loading weekly EPG data:",e),this.isLoadingEpg=!1,this.weeklyEpgData=null,this.epgRequested&&!this.showEpg&&(this.showEpg=!0,setTimeout(()=>{this.focusEpgComponent()},100))}})}initializePlayer(){return u(this,null,function*(){this.isVideoLoading=!0;try{if(this.player=z,this.player&&(window.onNativeChannelSelected=this.onNativeChannelSelected.bind(this),window.onNativeProgramSelected=this.onNativeProgramSelected.bind(this),window.onNativeQualitySelected=this.onNativeQualitySelected.bind(this),window.onNativeOverlayVisibilityChanged=this.onNativeOverlayVisibilityChanged.bind(this),window.onNativeInfoButtonClicked=this.onNativeInfoButtonClicked.bind(this),window.onNativeEpgButtonClicked=this.onNativeEpgButtonClicked.bind(this),window.onNativeSettingsButtonClicked=this.onNativeSettingsButtonClicked.bind(this),this.enableNativeOverlay(),this.updateNativeChannelList(),this.updateNativeProgramList()),this.currentChannel)this.currentChannel.active=!0,yield this.loadChannel(this.currentChannel);else{let e=this.channels[0];e?(e.active=!0,this.channelService.setCurrentChannel(e.index),yield this.loadChannel(e)):(yield this.player.load({url:"https://ireplay.tv/test/blender.m3u8"}),yield this.player.showBackground(),yield this.player.play())}this.playerLoaded=!0,this.isVideoLoading=!1,this.cdr.detectChanges()}catch(e){console.error("Error initializing ExoPlayer",e),this.isVideoLoading=!1,this.cdr.detectChanges()}})}toggleFullScreen(){console.log("Fullscreen toggle - ExoPlayer handles this natively")}loadChannel(e){return u(this,null,function*(){try{this.isVideoLoading=!0,this.cdr.detectChanges(),yield this.player.load({url:e.url}),yield this.player.showBackground(),yield this.player.play(),this.isVideoLoading=!1,this.cdr.detectChanges()}catch(t){console.error("Error loading channel",t),this.isVideoLoading=!1,this.cdr.detectChanges()}})}onShowLogo(){this.showLogo=!0,setTimeout(()=>{this.showLogo=!1},5e3)}selectChannel(e){let t=this.channels.find(n=>n.index===e);t&&(this.channels.forEach(n=>n.active=!1),t.active=!0,t.authorized&&(e===this.currentChannel.index&&this.onShowLogo(),this.channelService.setCurrentChannel(e),this.updateNativeChannelList(),this.updateNativeProgramList(),this.selectNativeChannel(e)))}selectChannelWhileMoving(e){let t=this.channels.find(n=>n.index===e);t&&(this.channels.forEach(n=>n.active=!1),t.active=!0,t.authorized&&this.channelService.setCurrentChannel(e))}getTranslateY(e){let n=this.channels.length,i=Math.min(6,Math.floor(n*1.5)),s=window.innerHeight/2-90/2+116,l=this.channels.find(c=>c.active);if(l&&n>0){let m=l.index-1-e;s-=m*90;let w=3;m>w?s+=n*90:m<-w&&(s-=n*90)}return l.index-1>3&&l.index-1-e===4&&(s=s-n*90),s}get selectedChannel(){return this.channels.find(t=>t.active)||this.currentChannel}handleKeyboardEvent(e){if(this.isListening){if(console.log("Live tv --- handleKeyboardEvent : ",e.key),this.isOverlayShowed){if((e.key==="Escape"||e.key==="Back"||e.key==="backButton"||e.key==="Backspace")&&this.isOverlayShowed){this.hideTVOverlay();return}}else if(e.key==="Enter"||e.key==="Select"||e.key==="OK"){this.showTVOverlay();return}}}onReturn(){this.showEpg?this.showEpg=!1:(this.resetVar(),this.navController.navigateForward("/home"))}showTVOverlay(){let e="https://ala-mesfar.github.io/tv-overlay-plugin/";console.log("\u{1F680} ~ LiveTvPage ~ showTVOverlay ~ url:",e),h.show({url:e}).then(()=>{this.isOverlayShowed=!0,console.log("TV overlay shown successfully")}).catch(t=>{console.error("Error showing TV overlay:",t)}),h.addListener("keyEvent",t=>{console.log("Key event from overlay:",t)})}hideTVOverlay(){h.hide().then(()=>{this.isOverlayShowed=!1,console.log("TV overlay hidden successfully")}).catch(e=>{console.error("Error hiding TV overlay:",e)})}destroyTVOverlay(){h.destroy().then(()=>{this.isOverlayShowed=!1,console.log("TV overlay destroyed successfully"),h.removeAllListeners()}).catch(e=>{console.error("Error destroying TV overlay:",e)})}getCurrentProgram(e){if(!e||!e.programmeDetails||e.programmeDetails.length===0)return null;let t=new Date;return e.programmeDetails.find(n=>{let i=new Date().toISOString().split("T")[0],o=new Date(`${i}T${n.start}:00`),a=new Date(`${i}T${n.end}:00`);return t>=o&&t<a})||null}isProgramLive(e){let t=new Date,n=t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0");return e.start<=n&&e.end>n}getUpcomingPrograms(e){var i;if(!((i=e==null?void 0:e.programmeDetails)!=null&&i.length))return[];let t=new Date,n=t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0");return e.programmeDetails.filter(o=>o.end>=n).sort((o,a)=>o.start.localeCompare(a.start)).slice(0,3)}openEgp(e){let t=e.target.closest("ion-button");t.classList.add("button-clicked"),setTimeout(()=>{t.classList.remove("button-clicked")},500),this.epgRequested=!0,!this.weeklyEpgData&&!this.isLoadingEpg&&this.loadWeeklyEpgData(),this.weeklyEpgData&&(this.showEpg=!0,setTimeout(()=>{this.focusEpgComponent()},100))}getProgramProgress(){let e=Date.now();if(e-this.lastProgressUpdate<this.PROGRESS_UPDATE_INTERVAL)return this.cachedProgress;if(!this.currentChannel)return this.cachedProgress=0,this.lastProgressUpdate=e,0;let t=this.getCurrentProgram(this.currentChannel);if(!t||!t.start||!t.end)return this.cachedProgress=0,this.lastProgressUpdate=e,0;let n=new Date(e),i=n.toISOString().split("T")[0],o=new Date(`${i}T${t.start}:00`),a=new Date(`${i}T${t.end}:00`);if(a<=o&&a.setDate(a.getDate()+1),n<o)this.cachedProgress=0;else if(n>a)this.cachedProgress=100;else{let s=a.getTime()-o.getTime(),c=(n.getTime()-o.getTime())/s*100;this.cachedProgress=Math.max(0,Math.min(100,c))}return this.lastProgressUpdate=e,this.cachedProgress}getCurrentProgramInfo(){return this.selectedChannel?this.getCurrentProgram(this.selectedChannel):null}getCurrentDate(){return new Date}closeEpg(){this.showEpg=!1,this.epgRequested=!1}focusEpgComponent(){let e=document.querySelector("app-epg");if(e){let t=e.querySelector('.epg-navigation-controls ion-button[tabindex="0"]');t?t.focus():e.focus()}}enableNativeOverlay(){this.player&&this.player.enableNativeOverlay()}disableNativeOverlay(){this.player&&this.player.disableNativeOverlay()}showNativeOverlay(){console.log("showNativeOverlay() called, player:",this.player),this.player?console.log("Calling this.player.showNativeOverlay()"):console.log("Player is null/undefined, cannot show native overlay")}hideNativeOverlay(){this.player&&this.player.hideNativeOverlay()}updateNativeChannelList(){if(this.player&&this.channels){let e=this.channels.map(t=>{var n;return{id:t.id,name:t.name,number:t.index,logo:t.logo,authorized:t.authorized,isSelected:t.index===((n=this.selectedChannel)==null?void 0:n.index)}});this.player.updateChannelList({channels:e})}}updateNativeProgramList(){if(this.player&&this.selectedChannel){let t=this.getUpcomingPrograms(this.selectedChannel).map(n=>({id:n.id||`${n.start}-${n.end}`,title:n.title,description:n.description||"",startTime:n.start,endTime:n.end,duration:this.calculateProgramDuration(n),progress:this.isProgramLive(n)?this.getProgramProgress():0,isCurrent:this.isProgramLive(n)}));this.player.updateProgramList({programs:t})}}updateNativeProgramProgress(){if(this.player){let e=this.getProgramProgress();this.player.updateProgramProgress(e)}}selectNativeChannel(e){this.player&&this.player.selectChannel(e)}calculateProgramDuration(e){if(!e.start||!e.end)return 0;let t=new Date().toISOString().split("T")[0],n=new Date(`${t}T${e.start}:00`),i=new Date(`${t}T${e.end}:00`);return i<=n&&i.setDate(i.getDate()+1),Math.round((i.getTime()-n.getTime())/(1e3*60))}onNativeChannelSelected(e){console.log("Native overlay channel selected:",e),this.selectChannel(e)}onNativeProgramSelected(e){console.log("Native overlay program selected:",e)}onNativeQualitySelected(e){console.log("Native overlay quality selected:",e),this.selectedQuality=e}onNativeOverlayVisibilityChanged(e){console.log("Native overlay visibility changed:",e)}onNativeInfoButtonClicked(){console.log("Native overlay info button clicked")}onNativeEpgButtonClicked(){console.log("Native overlay EPG button clicked"),this.openEgp({target:{closest:()=>({classList:{add:()=>{},remove:()=>{}}})}})}onNativeSettingsButtonClicked(){console.log("Native overlay settings button clicked")}};r.\u0275fac=function(t){return new(t||r)(d(A),d(F),d(O),d(_),d(M),d(L),d(N))},r.\u0275cmp=S({type:r,selectors:[["app-live-tv"]],hostBindings:function(t,n){t&1&&D("keydown",function(o){return n.handleKeyboardEvent(o)},!1,P)},decls:1,vars:1,consts:[[3,"fullscreen"]],template:function(t,n){t&1&&E(0,"ion-content",0),t&2&&k("fullscreen",!0)},dependencies:[V,B,T,I,H],styles:["*[_ngcontent-%COMP%]{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;outline:none}.fullscreen-container[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#000;z-index:1}.video-loading[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10;color:#fff;text-align:center}.video-loading[_ngcontent-%COMP%]   .loading-spinner[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:16px}.video-loading[_ngcontent-%COMP%]   .loading-spinner[_ngcontent-%COMP%]   ion-spinner[_ngcontent-%COMP%]{width:48px;height:48px;color:#fff}.video-loading[_ngcontent-%COMP%]   .loading-spinner[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;font-size:16px;color:#fff}.tv-overlay[_ngcontent-%COMP%]{position:fixed;top:0;right:0;bottom:0;left:0;display:grid;place-items:center;pointer-events:auto}.tv-overlay.hidden[_ngcontent-%COMP%]{display:none}.panel[_ngcontent-%COMP%]{min-width:60vw;max-width:80vw;background:#0009;-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);color:#fff;border-radius:16px;padding:24px}"]});let p=r;return p})();export{Pe as LiveTvPage};
